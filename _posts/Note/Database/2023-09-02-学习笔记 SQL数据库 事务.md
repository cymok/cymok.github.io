---
layout: post
tags: 数据库
---

# 事务

---

## 介绍

一系列操作需要 要不全部成功 要不全部失败

开启事务后，在提交之前，执行结果都只是在当前会话有效，是临时的

提交事务后，才会真正生效，持久更新

若其中有执行失败的，都应该回滚到开启时的状态

---

## 基本使用

```
// 开启事务
START TRANSACTION; -- MySQL
BEGIN TRANSACTION; -- SQLite
BEGIN; -- SQLite 可省略

// 提交事务
COMMIT;

// 回滚事务
ROLLBACK;
```

---

## 事务的提交

### 自动提交

- MySQL 默认自动提交

- Oracle 默认手动提交

- SQLite 默认自动提交

// 查看事务默认提交方式
SELECT @@autocommit; -- 1 代表自动提交, 0 代表手动提交

### 事务四大特征

- 原子性

不可分割，要么全部成功，要不全部失败

- 持久性

提交/回滚 后，持久更新

- 隔离性

会话独立

- 一致性

30+30 = 40+20

### 隔离级别

并发，多个事务同时操作一批数据，会引发问题

- 脏读：一个事务，读取到另一个事务中没有提交的数据
- 不可重复读：在同一个事务中，两次读取到的数据不一样
- 幻读(虚读)：一个事务操作(DML)数据表中所有记录，另一个事务添加了一条数据，则第一个事务查询不到自己的修改

隔离级别:

1. READ-UNCOMMITTED 读未提交(产生的问题：脏读、不可重复读、幻读)
2. READ-COMMITTED 读已提交(产生的问题：不可重复读、幻读) (Oracle默认级别)
3. REPEATABLE-READ 可重复读(产生的问题：幻读) (MySQL默认级别)
4. SERIALIZABLE 串行化 (直接给表加锁) (可以解决所有的问题) (SQLite默认级别)

特点：隔离级别越小 效率越高，隔离级别越大 安全性越高

// 查看隔离级别
SELECT @@tx_isolation;

// 设置隔离级别 (后面是级别)
SET GLOBAL TRANSACTION ISOLATION LEVEL READ COMMITTED;
